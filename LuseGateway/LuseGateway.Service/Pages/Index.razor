@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@using LuseGateway.Service.Services
@implements IAsyncDisposable

<PageTitle>Dashboard | LUSE FIX Gateway</PageTitle>

<div class="fade-in">
    <h1 class="mb-4">Gateway Overview</h1>

    <div class="row">
        <!-- Summary Stats -->
        <div class="col-md-3">
            <div class="glass-card text-center">
                <div class="small opacity-50 mb-1">Session Link</div>
                <h3 class="@(IsConnected ? "text-success" : "text-danger")">@(IsConnected ? "ACTIVE" : "DOWN")</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card text-center">
                <div class="small opacity-50 mb-1">Open Orders</div>
                <h3 class="text-accent">@GetStat("OPEN")</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card text-center">
                <div class="small opacity-50 mb-1">Matched Today</div>
                <h3 class="text-success">@GetStat("MATCHED ORDER")</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card text-center">
                <div class="small opacity-50 mb-1">Rejected Today</div>
                <h3 class="text-danger">@GetStat("REJECTED")</h3>
            </div>
        </div>
    </div>

    <div class="dashboard-grid mt-2">
        <!-- Main Actions -->
        <div class="main-panel">
            <div class="glass-card">
                <h3>Quick Actions</h3>
                <div class="row g-3">
                    <div class="col-md-6">
                        <button class="btn-glass w-100 py-3" @onclick="RequestSecurityDefs">
                            <span class="fs-4 d-block mb-1">ðŸ“‹</span>
                            Update Securities
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn-glass w-100 py-3" @onclick="RequestMarketData">
                            <span class="fs-4 d-block mb-1">ðŸ“ˆ</span>
                            Subscribe Feed
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn-glass w-100 py-3" @onclick="RequestPartyIDs">
                            <span class="fs-4 d-block mb-1">ðŸ‘¥</span>
                            Sync Parties
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn-glass w-100 py-3 border-danger-subtle" @onclick="ReconcileNow">
                            <span class="fs-4 d-block mb-1">ðŸ”„</span>
                            Force Reconcile
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Recent System Activity</h3>
                    <a href="market-data" class="small text-accent text-decoration-none">View All Logs â†’</a>
                </div>
                <div class="fix-log" style="height: 250px;">
                    @foreach (var msg in LogMessages.Take(10))
                    {
                        <div class="log-entry @(msg.Direction.ToLower())">
                            <span class="log-time">[@msg.Timestamp.ToString("HH:mm:ss")]</span>
                            <span class="log-dir">@(msg.Direction == "IN" ? "<< " : ">> ")</span>
                            <span class="log-content">@msg.Content.Substring(0, Math.Min(msg.Content.Length, 80))...</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Session Health -->
        <div class="side-panel">
            <div class="glass-card">
                <h3>Session Health</h3>
                <div class="stat-list mt-3">
                    <div class="stat-item">
                        <span class="stat-label">Sender ID</span>
                        <span class="stat-value text-accent">CTRLUSE</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Target ID</span>
                        <span class="stat-value text-accent">STT</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Host</span>
                        <span class="stat-value">10.200.2.14</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Messages In</span>
                        <span class="stat-value">@LogMessages.Count(m => m.Direction == "IN")</span>
                    </div>
                     <div class="stat-item">
                        <span class="stat-label">Messages Out</span>
                        <span class="stat-value">@LogMessages.Count(m => m.Direction == "OUT")</span>
                    </div>
                </div>
                <hr class="border-secondary" />
                <div class="small opacity-50 mt-2">
                    Gateway is currently monitoring the BSE Trading interface. All orders are automatically synced.
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Inject] private LuseGateway.Fix.LuseFixApplication? FixApp { get; set; }
    [Inject] private IFixMessageLogService? LogService { get; set; }
    [Inject] private IFixActionService? ActionService { get; set; }
    [Inject] private IOrderService? OrderService { get; set; }
    [Inject] private IOrderReconciliationService? ReconService { get; set; }
    [Inject] private NavigationManager? Navigation { get; set; }

    private List<FixMessageEntry> LogMessages = new();
    private Dictionary<string, int> OrderStats = new();
    private HubConnection? hubConnection;
    private bool IsConnected => FixApp?.ActiveSessionId != null;

    protected override async Task OnInitializedAsync()
    {
        if (LogService != null) LogMessages = LogService.GetRecentMessages().Reverse().ToList();
        await RefreshData();

        if (Navigation != null)
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/gatewayHub"))
                .Build();

            hubConnection.On<FixMessageEntry>("ReceiveFixMessage", async (message) =>
            {
                LogMessages.Insert(0, message);
                if (LogMessages.Count > 50) LogMessages.RemoveAt(LogMessages.Count - 1);
                await RefreshData();
                await InvokeAsync(StateHasChanged);
            });

            await hubConnection.StartAsync();
        }
    }

    private async Task RefreshData()
    {
        if (OrderService != null) OrderStats = await OrderService.GetOrderStatsAsync();
    }

    private string GetStat(string status) => OrderStats.TryGetValue(status, out var count) ? count.ToString() : "0";

    private async Task RequestSecurityDefs() { if (ActionService != null) await ActionService.RequestSecurityDefinitionsAsync(); }
    private async Task RequestMarketData() { if (ActionService != null) await ActionService.RequestMarketDataAsync("MSFT"); }
    private async Task RequestPartyIDs() { if (ActionService != null) await ActionService.RequestPartyIDsAsync(); }
    private async Task ReconcileNow() 
    { 
        if (ReconService != null) 
        {
            await ReconService.ReconcileOrdersAsync();
            await RefreshData();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null) await hubConnection.DisposeAsync();
    }
}
