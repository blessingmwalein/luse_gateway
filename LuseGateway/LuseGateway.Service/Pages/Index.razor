@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@using LuseGateway.Service.Services
@implements IAsyncDisposable

<PageTitle>LUSE Gateway Dashboard</PageTitle>

<div class="dashboard-grid fade-in">
    <!-- Left Column: Orders & Activity -->
    <div class="main-panel">
        @if (!string.IsNullOrEmpty(DbError))
        {
            <div class="glass-card border-danger">
                <div class="d-flex align-items-center text-danger">
                    <span class="fs-4 me-2">‚ö†Ô∏è</span>
                    <div>
                        <h4 class="mb-0">Database Error</h4>
                        <p class="mb-0 small">@DbError</p>
                    </div>
                </div>
            </div>
        }
        <div class="glass-card">
            <h3>Active Orders (PreOrderLive)</h3>
            <div class="order-table-container">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Order No</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Orders != null)
                        {
                            @foreach (var order in Orders)
                            {
                                <tr>
                                    <td>@order.OrderNo</td>
                                    <td>@(order.Symbol ?? "N/A")</td>
                                    <td><span class="badge @(order.Side == "BUY" ? "bg-success" : "bg-danger")">@(order.Side ?? "N/A")</span></td>
                                    <td>@order.Quantity</td>
                                    <td>@order.BasePrice.ToString("N2")</td>
                                    <td><span class="status-badge status-@((order.OrderStatus ?? "UNKNOWN").ToLower().Replace(" ", "-"))">@(order.OrderStatus ?? "UNKNOWN")</span></td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="glass-card">
            <h3>FIX Message Log</h3>
            <div class="fix-log" id="logContainer">
                @if (LogMessages != null)
                {
                    @foreach (var msg in LogMessages)
                    {
                        <div class="log-entry @(msg.Direction?.ToLower() ?? "unknown")">
                            <span class="log-time">[@msg.Timestamp.ToString("HH:mm:ss.fff")]</span>
                            <span class="log-dir">@(msg.Direction == "IN" ? "<< RECV" : ">> SEND")</span>
                            <span class="log-content">@msg.Content</span>
                        </div>
                    }
                }
            </div>
        </div>

        <div class="glass-card mt-4">
            <h3>Market Data Feed (CompanyPrices)</h3>
            <div class="order-table-container">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Bid</th>
                            <th>Ask</th>
                            <th>VWAP</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (MarketPrices != null)
                        {
                            @foreach (var price in MarketPrices)
                            {
                                <tr>
                                    <td>@(price.Company ?? "N/A")</td>
                                    <td class="text-success">@(price.BestBid?.ToString("N4") ?? "0.0000")</td>
                                    <td class="text-danger">@(price.BestAsk?.ToString("N4") ?? "0.0000")</td>
                                    <td class="text-accent">@(price.VwapPrice?.ToString("N4") ?? "0.0000")</td>
                                    <td class="small">@(price.SecurityType ?? "N/A")</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Right Column: Actions & Stats -->
    <div class="side-panel">
        <div class="glass-card">
            <h3>Gateway Actions</h3>
            <div class="d-grid gap-2">
                <button class="btn-glass btn-primary-glass" @onclick="RequestSecurityDefs">
                    <span class="btn-icon">üìã</span> Request Security Definitions
                </button>
                <button class="btn-glass" @onclick="RequestMarketData">
                    <span class="btn-icon">üìà</span> Subscribe Market Data (MSFT)
                </button>
                <button class="btn-glass" @onclick="RequestPartyIDs">
                    <span class="btn-icon">üë•</span> Synchronize Party IDs
                </button>
                <button class="btn-glass" @onclick="CheckOrderStatus">
                    <span class="btn-icon">üîç</span> Query Order Status
                </button>
            </div>
        </div>

        <div class="glass-card">
            <h3>Session Statistics</h3>
            <div class="stats-list">
                <div class="stat-item">
                    <span class="stat-label">Active Session:</span>
                    <span class="stat-value text-accent">@(FixApp?.ActiveSessionId?.ToString() ?? "NONE")</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Messages In:</span>
                    <span class="stat-value">@(LogMessages?.Count(m => m.Direction == "IN") ?? 0)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Messages Out:</span>
                    <span class="stat-value">@(LogMessages?.Count(m => m.Direction == "OUT") ?? 0)</span>
                </div>
                <hr class="border-secondary my-2" />
                @if (OrderStats != null)
                {
                    @foreach (var stat in OrderStats)
                    {
                        <div class="stat-item">
                            <span class="stat-label">@(stat.Key ?? "UNKNOWN"):</span>
                            <span class="stat-value badge @GetStatusBadgeClass(stat.Key ?? "UNKNOWN")">@stat.Value</span>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Inject] private LuseGateway.Fix.LuseFixApplication? FixApp { get; set; }
    [Inject] private IFixMessageLogService? LogService { get; set; }
    [Inject] private IFixActionService? ActionService { get; set; }
    [Inject] private IOrderService? OrderService { get; set; }
    [Inject] private NavigationManager? Navigation { get; set; }

    private List<FixMessageEntry> LogMessages = new();
    private List<PreOrderLive> Orders = new();
    private List<CompanyPrice> MarketPrices = new();
    private Dictionary<string, int> OrderStats = new();
    private HubConnection? hubConnection;
    private string? DbError;

    protected override async Task OnInitializedAsync()
    {
        if (LogService != null)
        {
            LogMessages = LogService.GetRecentMessages().ToList();
        }
        await RefreshData();

        if (Navigation != null)
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/gatewayHub"))
                .Build();

            hubConnection.On<FixMessageEntry>("ReceiveFixMessage", async (message) =>
            {
                LogMessages.Insert(0, message);
                if (LogMessages.Count > 100) LogMessages.RemoveAt(LogMessages.Count - 1);
                
                // Auto-refresh data on new messages
                await RefreshData();
                await InvokeAsync(StateHasChanged);
            });

            await hubConnection.StartAsync();
        }
    }

    private async Task RefreshData()
    {
        if (OrderService == null) return;

        try 
        {
            var pending = await OrderService.GetPendingOrdersAsync();
            Orders = pending.Take(5).ToList();
            
            var prices = await OrderService.GetCompanyPricesAsync();
            MarketPrices = prices.ToList();
            
            OrderStats = await OrderService.GetOrderStatsAsync();
            DbError = null;
        }
        catch (Exception ex)
        {
            DbError = $"Database error: {ex.Message}";
        }
    }

    private string GetStatusBadgeClass(string status) => (status ?? "").ToUpper() switch
    {
        "MATCHED ORDER" => "bg-success",
        "REJECTED" => "bg-danger",
        "OPEN" => "bg-info",
        "NEW" => "bg-primary",
        _ => "bg-secondary"
    };

    private async Task RequestSecurityDefs() => await ActionService.RequestSecurityDefinitionsAsync();
    private async Task RequestMarketData() => await ActionService.RequestMarketDataAsync("MSFT");
    private async Task RequestPartyIDs() => await ActionService.RequestPartyIDsAsync();
    private async Task CheckOrderStatus() => await ActionService.RequestOrderStatusAsync("SAMPLE_ID");

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
